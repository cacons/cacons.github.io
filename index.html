<!DOCTYPE html>
<html lang="it">
<head>
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConcaMusic</title>
    <script>
        const clientId = "7821f85ba11b4cf1889417e0f6430583";
        const clientSecret = "bc16f8eb9858405292d12d15c2875406";
        let accessToken = "";

        async function getSpotifyToken() {
            const response = await fetch("https://accounts.spotify.com/api/token", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `grant_type=client_credentials&client_id=${clientId}&client_secret=${clientSecret}`
            });
            const data = await response.json();
            accessToken = data.access_token;
        }

        async function searchAlbum() {
            let nome = document.getElementById("nome").value;
            let artista = document.getElementById("artista").value;
            if (!nome || !artista) return;

            const url = `https://api.spotify.com/v1/search?q=album:${encodeURIComponent(nome)}+artist:${encodeURIComponent(artista)}&type=album&limit=1`;
            const response = await fetch(url, {
                headers: { "Authorization": `Bearer ${accessToken}` }
            });
            const data = await response.json();
            
            if (data.albums.items.length > 0) {
                document.getElementById("immagine").value = data.albums.items[0].images[0].url;
            }
        }

        function getData() {
            let channelID = "2825701"; 
            let apiKey = "SJIIZ0GS9AZSGU8A";
            let url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${apiKey}&results=10`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    let output = "<h2>Album Registrati</h2><ul>";
                    data.feeds.forEach(feed => {
                        output += `<li><strong>Nome:</strong> ${feed.field1} <br>
                                   <strong>Artista:</strong> ${feed.field2} <br>
                                   <strong>Genere:</strong> ${feed.field3} <br>
                                   <strong>Anno:</strong> ${feed.field4} <br>
                                   <img src="${feed.field5}" alt="Copertina Album" style="width:100px;"></li><br>`;
                    });
                    output += "</ul>";
                    document.getElementById("response").innerHTML = output;
                })
                .catch(error => console.error("Errore nella richiesta GET:", error));
        }
        
        function sendData() {
            let apiKey = "ZV0BVNOA1XUBDBVU";
            let nome = document.getElementById("nome").value;
            let artista = document.getElementById("artista").value;
            let genere = document.getElementById("genere").value;
            let anno = document.getElementById("anno").value;
            let immagine = document.getElementById("immagine").value;
            let url = `https://api.thingspeak.com/update?api_key=${apiKey}&field1=${nome}&field2=${artista}&field3=${genere}&field4=${anno}&field5=${immagine}`;
            
            fetch(url, { method: "POST" })
                .then(response => response.text())
                .then(data => {
                    document.getElementById("response").innerText = "Album inserito con successo! ID: " + data;
                })
                .catch(error => console.error("Errore nella richiesta POST:", error));
        }

        window.onload = getSpotifyToken;
    </script>
</head>
<body>
    <h1>ConcaMusic</h1>
    <h2>Inserisci un Nuovo Album</h2>
    <input type="text" id="nome" placeholder="Nome Album" onblur="searchAlbum()"><br>
    <input type="text" id="artista" placeholder="Artista" onblur="searchAlbum()"><br>
    <input type="text" id="genere" placeholder="Genere"><br>
    <input type="number" id="anno" placeholder="Anno"><br>
    <input type="text" id="immagine" placeholder="URL Copertina Album"><br>
    <button onclick="sendData()">Salva Album</button>
    <br><br>
    <a href="album.html">Visualizza Album Registrati</a>

</body>
</html>
